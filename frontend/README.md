# å‰ç«¯ç›‘æ§ç³»ç»Ÿæ–‡æ¡£

> å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–æµ‹è¯•çš„å®æ—¶ç›‘æ§ç•Œé¢

## ğŸ“– ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [åŠŸèƒ½åˆ—è¡¨](#åŠŸèƒ½åˆ—è¡¨)
- [æŠ€æœ¯æ–¹æ¡ˆ](#æŠ€æœ¯æ–¹æ¡ˆ)
- [åœæ­¢æŒ‰é’®è¯´æ˜](#åœæ­¢æŒ‰é’®è¯´æ˜)
- [ä½¿ç”¨æŒ‡å—](#ä½¿ç”¨æŒ‡å—)
- [é—®é¢˜æ’æŸ¥](#é—®é¢˜æ’æŸ¥)
- [æ‰©å±•å¼€å‘](#æ‰©å±•å¼€å‘)

---

## æ¦‚è¿°

å‰ç«¯ç›‘æ§ç³»ç»Ÿé€šè¿‡**é›¶ä¾µå…¥å¼é›†æˆ**æ–¹æ¡ˆï¼Œåœ¨ä¸ä¿®æ”¹ `src/` æ ¸å¿ƒä»£ç çš„å‰æä¸‹ï¼Œå®ç°æ—¥å¿—ã€è¿›åº¦ã€æˆªå›¾çš„å®æ—¶å‰ç«¯åŒæ­¥ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **å®æ—¶æ—¥å¿—åŒæ­¥** - æ‰€æœ‰ logging è¾“å‡ºè‡ªåŠ¨æ¨é€åˆ°å‰ç«¯
- âœ… **æ“ä½œçŠ¶æ€è¯†åˆ«** - æ™ºèƒ½è¯†åˆ«å½“å‰æ“ä½œï¼ˆå¦‚"æ‰“å¼€å¾®ä¿¡"ã€"VLMè¯†åˆ«ä¸­"ï¼‰
- âœ… **è¿›åº¦ç»Ÿè®¡æ˜¾ç¤º** - è‡ªåŠ¨æå–å¹¶æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
- âœ… **æˆªå›¾å®æ—¶æ¨é€** - æ¯æ¬¡æˆªå›¾è‡ªåŠ¨æ¨é€ï¼ˆbase64ç¼–ç ï¼‰
- âœ… **æ–‡ç« é“¾æ¥é‡‡é›†** - å®æ—¶æ˜¾ç¤ºé‡‡é›†çš„æ–‡ç« é“¾æ¥
- âœ… **åœæ­¢æŒ‰é’®å“åº”** - ç‚¹å‡»åœæ­¢åç«‹å³ä¸­æ–­ï¼ˆæœ€å¤šå»¶è¿Ÿ 0.1 ç§’ï¼‰
- âœ… **é›¶ä»£ç ä¾µå…¥** - å®Œå…¨ä¸ä¿®æ”¹ `src/` ä¸­çš„ä»»ä½•ä»£ç 

### æŠ€æœ¯äº®ç‚¹

1. **é›¶ä¾µå…¥æ€§** - é€šè¿‡è‡ªå®šä¹‰ logging Handler å’Œ monkey patching å®ç°
2. **è‡ªåŠ¨åŒ–** - åªéœ€é…ç½®ä¸€æ¬¡ï¼Œæ‰€æœ‰æ—¥å¿—è‡ªåŠ¨è½¬å‘
3. **æ™ºèƒ½è§£æ** - é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è‡ªåŠ¨è¯†åˆ«çŠ¶æ€ã€è¿›åº¦ã€é“¾æ¥
4. **å®¹é”™æ€§å¼º** - WebSocket æ–­å¼€ä¸å½±å“ä¸»æµç¨‹
5. **æ˜“äºæ‰©å±•** - æ·»åŠ æ–°åŠŸèƒ½åªéœ€ä¿®æ”¹æ­£åˆ™è§„åˆ™

---

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼1ï¼šå¿«é€Ÿå¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd /Users/tongtong/code/wechat-ai-daily

# æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆæ— éœ€å¾®ä¿¡ç¯å¢ƒï¼‰
./start_frontend_test.sh simulation

# çœŸå®æµ‹è¯•ï¼ˆéœ€è¦å¾®ä¿¡ç¯å¢ƒï¼‰
./start_frontend_test.sh real
```

### æ–¹å¼2ï¼šç›´æ¥è¿è¡Œ

```bash
# æ¨¡æ‹Ÿæµ‹è¯•
uv run python tests/test_frontend_integration.py

# çœŸå®æµ‹è¯•
uv run python tests/test_with_frontend.py
```

### æ“ä½œæ­¥éª¤

1. è„šæœ¬ä¼šè‡ªåŠ¨å¯åŠ¨å‰ç«¯æœåŠ¡å™¨ï¼š`http://localhost:8765`
2. æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ç›‘æ§é¡µé¢
3. ç‚¹å‡»é¡µé¢ä¸Šçš„ **"â–¶ï¸ å¼€å§‹æµ‹è¯•"** æŒ‰é’®
4. è§‚å¯Ÿå®æ—¶æ—¥å¿—ã€æˆªå›¾ã€è¿›åº¦æ›´æ–°
5. å¯ä»¥ç‚¹å‡» **"â¹ï¸ åœæ­¢æµ‹è¯•"** ä¸­æ–­æ‰§è¡Œ

---

## åŠŸèƒ½åˆ—è¡¨

### âœ… å®æ—¶æ—¥å¿—åŒæ­¥

**åŠŸèƒ½æè¿°ï¼š**
- æ‹¦æˆªæ‰€æœ‰ Python logging è¾“å‡º
- è‡ªåŠ¨æ¨é€åˆ°å‰ç«¯ WebSocket
- æŒ‰æ—¶é—´é¡ºåºæ˜¾ç¤ºï¼Œå¸¦é¢œè‰²åŒºåˆ†

**æ—¥å¿—çº§åˆ«æ˜ å°„ï¼š**
- `logging.INFO` â†’ è“è‰²ï¼ˆinfoï¼‰
- `logging.WARNING` â†’ é»„è‰²ï¼ˆwarningï¼‰
- `logging.ERROR` â†’ çº¢è‰²ï¼ˆerrorï¼‰
- åŒ…å«"æˆåŠŸ"ã€"å®Œæˆ"å…³é”®è¯ â†’ ç»¿è‰²ï¼ˆsuccessï¼‰

### âœ… æ“ä½œçŠ¶æ€è¯†åˆ«

**åŠŸèƒ½æè¿°ï¼š**
- è‡ªåŠ¨ä»æ—¥å¿—ä¸­è¯†åˆ«å½“å‰æ“ä½œ
- å®æ—¶æ›´æ–°å‰ç«¯"å½“å‰æ“ä½œ"åŒºåŸŸ

**æ”¯æŒçš„çŠ¶æ€ï¼š**
- "æ­£åœ¨æ‰“å¼€å¾®ä¿¡"
- "å¾®ä¿¡åº”ç”¨å·²å°±ç»ª"
- "æ‰“å¼€å¾®ä¿¡æœç´¢"
- "æœç´¢ç•Œé¢å·²å°±ç»ª"
- "æ­£åœ¨æœç´¢å…¬ä¼—å·"
- "è¿›å…¥å…¬ä¼—å·ä¸»é¡µ"
- "å¼€å§‹é‡‡é›†æ–‡ç« "
- "ä½¿ç”¨ VLM è¯†åˆ«æ—¥æœŸ"
- "VLM è¯†åˆ«å®Œæˆ"
- "æ­£åœ¨ç‚¹å‡»æ–‡ç« "
- "æ­£åœ¨å¤åˆ¶é“¾æ¥"
- "é“¾æ¥å¤åˆ¶æˆåŠŸ"
- "è¿”å›ä¸»é¡µ"
- "æ»šåŠ¨åŠ è½½æ›´å¤š"
- "å½“å‰å…¬ä¼—å·é‡‡é›†å®Œæˆ"
- "å…¨éƒ¨é‡‡é›†å®Œæˆ"

### âœ… è¿›åº¦ç»Ÿè®¡æ˜¾ç¤º

**åŠŸèƒ½æè¿°ï¼š**
- è‡ªåŠ¨è¯†åˆ« "å¤„ç†ç¬¬ x/y ä¸ª" æ ¼å¼çš„è¿›åº¦ä¿¡æ¯
- å®æ—¶æ›´æ–°å‰ç«¯è¿›åº¦æ¡å’Œæ•°å­—

**æ”¯æŒçš„æ ¼å¼ï¼š**
- "æ­£åœ¨å¤„ç†ç¬¬ 1/2 ä¸ªå…¬ä¼—å·"
- "å¤„ç†ç¬¬ 1/3 ä¸ªæ–‡ç« ä½ç½®"

### âœ… æˆªå›¾å®æ—¶æ¨é€

**åŠŸèƒ½æè¿°ï¼š**
- æ‹¦æˆª `autogui.screenshot_current_window` å‡½æ•°
- æ¯æ¬¡æˆªå›¾è‡ªåŠ¨æ¨é€åˆ°å‰ç«¯
- Base64 ç¼–ç ä¼ è¾“

**é¢‘ç‡æ§åˆ¶ï¼š**
- æœ€å°é—´éš”ï¼š2 ç§’
- é¿å…è¿‡åº¦æ¨é€ï¼Œå‡å°‘ç½‘ç»œè´Ÿè½½

### âœ… æ–‡ç« é“¾æ¥é‡‡é›†

**åŠŸèƒ½æè¿°ï¼š**
- è‡ªåŠ¨è¯†åˆ«æ—¥å¿—ä¸­çš„å¾®ä¿¡æ–‡ç« é“¾æ¥
- å®æ—¶æ˜¾ç¤ºåœ¨å‰ç«¯åˆ—è¡¨ä¸­

**é“¾æ¥æ ¼å¼ï¼š**
- `https://mp.weixin.qq.com/s/xxxxx`

### âœ… åœæ­¢æŒ‰é’®åŠŸèƒ½

**åŠŸèƒ½æè¿°ï¼š**
- å‰ç«¯ç‚¹å‡»åœæ­¢åç«‹å³å“åº”
- æœ€å¤§å»¶è¿Ÿ 0.1 ç§’

**å®ç°åŸç†ï¼š**
- Monkey patch `time.sleep` ä¸ºå¯ä¸­æ–­ç‰ˆæœ¬
- æ¯ 0.1 ç§’æ£€æŸ¥ä¸€æ¬¡åœæ­¢ä¿¡å·
- æ”¶åˆ°åœæ­¢ä¿¡å·æ—¶æŠ›å‡º `KeyboardInterrupt`

---

## æŠ€æœ¯æ–¹æ¡ˆ

### æ¶æ„ç»„ä»¶

```
frontend/
â”œâ”€â”€ index.html              # å‰ç«¯ç›‘æ§é¡µé¢
â”œâ”€â”€ server.py               # FastAPI + WebSocket æœåŠ¡å™¨
â”œâ”€â”€ progress_reporter.py    # è¿›åº¦ä¸ŠæŠ¥å™¨
â””â”€â”€ logging_handler.py      # æ—¥å¿—æ‹¦æˆªå™¨
```

### 1. æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆlogging_handler.pyï¼‰

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- æ‹¦æˆªæ‰€æœ‰ Python logging è¾“å‡º
- è‡ªåŠ¨è¯†åˆ«æ“ä½œçŠ¶æ€ï¼ˆé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼ï¼‰
- æå–è¿›åº¦ä¿¡æ¯ï¼ˆå¦‚"å¤„ç†ç¬¬ 1/2 ä¸ªå…¬ä¼—å·"ï¼‰
- è¯†åˆ«æ–‡ç« é“¾æ¥å¹¶æ¨é€

**ä½¿ç”¨æ–¹æ³•ï¼š**

```python
from frontend.logging_handler import setup_logging_forwarding, remove_logging_forwarding
from frontend.progress_reporter import ProgressReporter

# 1. åˆ›å»º reporter
reporter = ProgressReporter()

# 2. è®¾ç½®æ—¥å¿—è½¬å‘
handler = setup_logging_forwarding(reporter)

# 3. è¿è¡Œä½ çš„ä»£ç ï¼ˆæ‰€æœ‰ logging è¾“å‡ºä¼šè‡ªåŠ¨æ¨é€ï¼‰
# ...

# 4. æ¸…ç†
remove_logging_forwarding(handler)
```

**æ—¥å¿—è§£æè§„åˆ™ï¼š**

```python
self.status_patterns = [
    (r'æ­£åœ¨æ‰“å¼€å¾®ä¿¡|æ‰“å¼€/æ¿€æ´»å¾®ä¿¡', 'æ­£åœ¨æ‰“å¼€å¾®ä¿¡'),
    (r'å¾®ä¿¡å·²å¯åŠ¨|å¾®ä¿¡åº”ç”¨å·²å°±ç»ª', 'å¾®ä¿¡åº”ç”¨å·²å°±ç»ª'),
    (r'æ­£åœ¨è¯†åˆ«å½“å¤©æ—¥æœŸ|VLM è¯†åˆ«ä¸­', 'ä½¿ç”¨ VLM è¯†åˆ«æ—¥æœŸ'),
    # ... æ›´å¤šè§„åˆ™
]

self.progress_patterns = [
    r'æ­£åœ¨å¤„ç†ç¬¬\s*(\d+)/(\d+)\s*ä¸ªå…¬ä¼—å·',
    r'å¤„ç†ç¬¬\s*(\d+)/(\d+)\s*ä¸ªæ–‡ç« ä½ç½®',
]

self.article_link_pattern = r'(https://mp\.weixin\.qq\.com/s/[A-Za-z0-9_-]+)'
```

### 2. è¿›åº¦ä¸ŠæŠ¥å™¨ï¼ˆprogress_reporter.pyï¼‰

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- ç®¡ç† WebSocket å®¢æˆ·ç«¯è¿æ¥
- æ¨é€å„ç±»æ¶ˆæ¯åˆ°å‰ç«¯
- é¢‘ç‡æ§åˆ¶å’Œé”™è¯¯å¤„ç†

**å…³é”®ä¿®å¤ï¼š**
- ä¿®å¤äº† `asyncio.create_task` åœ¨é async ä¸Šä¸‹æ–‡ä¸­çš„è°ƒç”¨é—®é¢˜
- ä½¿ç”¨ `asyncio.get_running_loop()` è·å–å½“å‰äº‹ä»¶å¾ªç¯
- å…¼å®¹å¤šç§ WebSocket å‘é€æ–¹æ³•ï¼ˆ`send_text` å’Œ `send`ï¼‰

**ä¸»è¦æ–¹æ³•ï¼š**

```python
reporter.send_log(level, message)              # å‘é€æ—¥å¿—
reporter.send_status(step, detail)             # å‘é€æ“ä½œçŠ¶æ€
reporter.send_screenshot(img_path)             # å‘é€æˆªå›¾
reporter.send_progress(current, total)         # å‘é€è¿›åº¦
reporter.send_article(link, title, date)       # å‘é€æ–‡ç« 
reporter.send_workflow_start(total_accounts)   # å·¥ä½œæµå¯åŠ¨
reporter.send_workflow_end(success, stats)     # å·¥ä½œæµç»“æŸ
```

### 3. Monkey Patchingï¼ˆtest_with_frontend.pyï¼‰

**æˆªå›¾æ‹¦æˆªï¼š**

```python
# ä¿å­˜åŸå§‹å‡½æ•°
original_screenshot_func = autogui.screenshot_current_window

# åŒ…è£…å‡½æ•°
def monitored_screenshot(save_path):
    result = original_screenshot_func(save_path)
    reporter.send_screenshot(save_path)  # è‡ªåŠ¨æ¨é€
    return result

# æ›¿æ¢å‡½æ•°
autogui.screenshot_current_window = monitored_screenshot
```

**å¯ä¸­æ–­çš„ sleepï¼š**

```python
# ä¿å­˜åŸå§‹ time.sleep
original_time_sleep = time.sleep

# åŒ…è£…ä¸ºå¯ä¸­æ–­ç‰ˆæœ¬
def interruptible_sleep(seconds):
    """æ¯ 0.1 ç§’æ£€æŸ¥ä¸€æ¬¡åœæ­¢ä¿¡å·"""
    end_time = time.time() + seconds
    while time.time() < end_time:
        if stop_event.is_set():
            raise KeyboardInterrupt("ç”¨æˆ·ç‚¹å‡»åœæ­¢")
        remaining = end_time - time.time()
        if remaining > 0:
            original_time_sleep(min(0.1, remaining))

# æ›¿æ¢ time.sleep
time.sleep = interruptible_sleep
```

### 4. WebSocket æœåŠ¡å™¨ï¼ˆserver.pyï¼‰

**åŠŸèƒ½ï¼š**
- æ‰˜ç®¡å‰ç«¯ HTML é¡µé¢
- å»ºç«‹ WebSocket è¿æ¥
- è½¬å‘æµ‹è¯•è¿›åº¦ä¿¡æ¯åˆ°å‰ç«¯
- æ¥æ”¶å‰ç«¯æ§åˆ¶å‘½ä»¤ï¼ˆå¯åŠ¨/åœæ­¢ï¼‰

**ç«¯ç‚¹ï¼š**
- `GET /` - è¿”å›å‰ç«¯é¡µé¢
- `WebSocket /ws` - WebSocket è¿æ¥

**æ¶ˆæ¯æ ¼å¼ï¼š**

```javascript
// å‰ç«¯ -> åç«¯
{
    "action": "start" | "stop"
}

// åç«¯ -> å‰ç«¯
{
    "type": "log" | "status" | "screenshot" | "progress" | "article" | "workflow_start" | "workflow_end",
    "data": { ... }
}
```

---

## åœæ­¢æŒ‰é’®è¯´æ˜

### é—®é¢˜èƒŒæ™¯

**åŸé—®é¢˜ï¼š** å‰ç«¯ç‚¹å‡»"åœæ­¢æµ‹è¯•"æŒ‰é’®å¹¶ç¡®è®¤åï¼Œå·¥ä½œæµä»ç„¶ç»§ç»­æ‰§è¡Œã€‚

**æ ¹æœ¬åŸå› ï¼š** å·¥ä½œæµä»£ç ä¸­å¤§é‡ä½¿ç”¨äº† `time.sleep(3)` ç­‰é˜»å¡è°ƒç”¨ã€‚åœ¨ `sleep` æœŸé—´ï¼Œå³ä½¿å‰ç«¯å‘é€äº†åœæ­¢ä¿¡å·ï¼Œä»£ç ä¹Ÿæ— æ³•æ£€æŸ¥åˆ°ï¼Œå¿…é¡»ç­‰å¾… `sleep` ç»“æŸã€‚

### è§£å†³æ–¹æ¡ˆ

é€šè¿‡ **monkey patch `time.sleep`** å®ç°å¯ä¸­æ–­çš„ç¡çœ å‡½æ•°ï¼š

```python
def interruptible_sleep(seconds):
    """å¯ä¸­æ–­çš„ sleepï¼Œæ¯ 0.1 ç§’æ£€æŸ¥ä¸€æ¬¡åœæ­¢ä¿¡å·"""
    end_time = time.time() + seconds
    while time.time() < end_time:
        if stop_event.is_set():
            # æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œç«‹å³é€€å‡º
            raise KeyboardInterrupt("ç”¨æˆ·åœ¨å‰ç«¯ç‚¹å‡»åœæ­¢")
        # ç¡çœ  0.1 ç§’æˆ–å‰©ä½™æ—¶é—´ï¼ˆå–è¾ƒå°å€¼ï¼‰
        remaining = end_time - time.time()
        if remaining > 0:
            original_time_sleep(min(0.1, remaining))
```

### å·¥ä½œæµç¨‹

1. **ç”¨æˆ·ç‚¹å‡»åœæ­¢** â†’ ç¡®è®¤å¯¹è¯æ¡† â†’ ç‚¹å‡»"ç¡®è®¤"
2. **WebSocket å‘é€** â†’ `{"action": "stop"}`
3. **åç«¯æ¥æ”¶** â†’ `stop_event.set()`
4. **ç«‹å³å“åº”** â†’ `interruptible_sleep` æ£€æŸ¥åˆ°ä¿¡å·ï¼ŒæŠ›å‡º `KeyboardInterrupt`
5. **æ¸…ç†é€€å‡º** â†’ æ¢å¤åŸå§‹å‡½æ•°ï¼Œå‘é€ç»“æŸä¿¡å·

### å“åº”æ—¶é—´

- **æœ€å¤§å»¶è¿Ÿï¼š** 0.1 ç§’
- **å…¸å‹åœºæ™¯ï¼š**
  - åœ¨ `time.sleep(3)` æœŸé—´ç‚¹å‡»åœæ­¢ â†’ æœ€å¤š 0.1 ç§’ååœæ­¢
  - åœ¨æ‰§è¡Œå…¶ä»–æ“ä½œæ—¶ç‚¹å‡»åœæ­¢ â†’ ç«‹å³åœæ­¢

### æµ‹è¯•æ–¹æ³•

1. å¯åŠ¨æµ‹è¯•ï¼š`./start_frontend_test.sh real`
2. ç‚¹å‡»"å¼€å§‹æµ‹è¯•"
3. ç­‰å¾…å·¥ä½œæµå¼€å§‹æ‰§è¡Œ
4. ç‚¹å‡»"åœæ­¢æµ‹è¯•" â†’ ç¡®è®¤
5. âœ… å·¥ä½œæµåº”åœ¨ 0.1 ç§’å†…åœæ­¢

**é¢„æœŸè¡Œä¸ºï¼š**
- å‰ç«¯çŠ¶æ€ï¼š`è¿è¡Œä¸­` â†’ `å·²åœæ­¢ â¹ï¸`
- çŠ¶æ€ç¯ï¼šğŸŸ¢ ç»¿è‰² â†’ ğŸ”´ çº¢è‰²
- æ—¥å¿—æ˜¾ç¤ºï¼š`[ERROR] å·¥ä½œæµå·²åœæ­¢: ç”¨æˆ·ä¸­æ–­`

---

## ä½¿ç”¨æŒ‡å—

### åŸºæœ¬ä½¿ç”¨

#### 1. ç¯å¢ƒå‡†å¤‡

```bash
# ç¡®ä¿å·²å®‰è£…ä¾èµ–
uv sync

# è®¾ç½®ç¯å¢ƒå˜é‡
export DASHSCOPE_API_KEY="your_api_key_here"

# é…ç½®æ–‡ç«  URL
vim configs/config.yaml
```

#### 2. å¯åŠ¨æµ‹è¯•

```bash
# æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯åŠŸèƒ½ï¼‰
./start_frontend_test.sh simulation

# çœŸå®æµ‹è¯•ï¼ˆéœ€è¦å¾®ä¿¡ç¯å¢ƒï¼‰
./start_frontend_test.sh real
```

#### 3. å‰ç«¯æ“ä½œ

1. æµè§ˆå™¨è‡ªåŠ¨æ‰“å¼€ `http://localhost:8765`
2. æŸ¥çœ‹ WebSocket è¿æ¥çŠ¶æ€ï¼ˆå³ä¸Šè§’åº”æ˜¾ç¤º"å·²è¿æ¥"ï¼‰
3. ç‚¹å‡» **"â–¶ï¸ å¼€å§‹æµ‹è¯•"** æŒ‰é’®
4. è§‚å¯Ÿå®æ—¶æ›´æ–°ï¼š
   - æ—¥å¿—åŒºåŸŸï¼šæŸ¥çœ‹è¯¦ç»†æ‰§è¡Œæ—¥å¿—
   - å½“å‰æ“ä½œï¼šæŸ¥çœ‹å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ­¥éª¤
   - æˆªå›¾åŒºåŸŸï¼šæŸ¥çœ‹æœ€æ–°æˆªå›¾
   - é‡‡é›†çš„æ–‡ç« ï¼šæŸ¥çœ‹å·²é‡‡é›†çš„æ–‡ç« é“¾æ¥
   - ç»Ÿè®¡æ•°æ®ï¼šæŸ¥çœ‹å…¬ä¼—å·æ•°é‡ã€æ–‡ç« æ•°é‡ã€æ‰§è¡Œæ—¶é•¿
5. éœ€è¦åœæ­¢æ—¶ç‚¹å‡» **"â¹ï¸ åœæ­¢æµ‹è¯•"** æŒ‰é’®

### é›†æˆåˆ°ä½ çš„ä»£ç 

å¦‚æœä½ æƒ³åœ¨å…¶ä»–è„šæœ¬ä¸­ä½¿ç”¨å‰ç«¯ç›‘æ§ï¼š

```python
import asyncio
from frontend.progress_reporter import ProgressReporter
from frontend.logging_handler import setup_logging_forwarding, remove_logging_forwarding

async def your_workflow():
    # 1. åˆ›å»º reporter
    reporter = ProgressReporter()
    
    # 2. è®¾ç½®æ—¥å¿—è½¬å‘
    handler = setup_logging_forwarding(reporter)
    
    # 3. æ‹¦æˆªæˆªå›¾ï¼ˆå¯é€‰ï¼‰
    from wechat_ai_daily.utils import autogui
    original_screenshot = autogui.screenshot_current_window
    
    def monitored_screenshot(path):
        result = original_screenshot(path)
        reporter.send_screenshot(path)
        return result
    
    autogui.screenshot_current_window = monitored_screenshot
    
    try:
        # 4. è¿è¡Œä½ çš„å·¥ä½œæµ
        # æ‰€æœ‰ logging è¾“å‡ºä¼šè‡ªåŠ¨æ¨é€åˆ°å‰ç«¯
        await your_actual_workflow()
    finally:
        # 5. æ¸…ç†
        remove_logging_forwarding(handler)
        autogui.screenshot_current_window = original_screenshot
```

---

## é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šå‰ç«¯æ²¡æœ‰æ—¥å¿—æ›´æ–°

**å¯èƒ½åŸå› ï¼š**
- WebSocket è¿æ¥æ–­å¼€
- æ²¡æœ‰è¿è¡Œåœ¨ async ç¯å¢ƒä¸­
- æ—¥å¿—çº§åˆ«è®¾ç½®è¿‡é«˜

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥å‰ç«¯å³ä¸Šè§’çŠ¶æ€ï¼ˆåº”æ˜¾ç¤º"å·²è¿æ¥"ï¼‰
2. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰ "æ— è¿è¡Œä¸­çš„äº‹ä»¶å¾ªç¯" è­¦å‘Š
3. ç¡®è®¤ä»£ç è¿è¡Œåœ¨ `asyncio.run()` ç¯å¢ƒä¸­
4. æ£€æŸ¥æ—¥å¿—çº§åˆ«ï¼š`logging.basicConfig(level=logging.INFO)`

### é—®é¢˜2ï¼šæˆªå›¾æ²¡æœ‰æ›´æ–°

**å¯èƒ½åŸå› ï¼š**
- è§¦å‘é¢‘ç‡é™åˆ¶ï¼ˆ2ç§’é—´éš”ï¼‰
- æˆªå›¾æ–‡ä»¶è·¯å¾„é”™è¯¯
- WebSocket è¿æ¥å¼‚å¸¸

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æˆªå›¾æ–‡ä»¶æ˜¯å¦ç”Ÿæˆï¼ˆ`temp/screenshot.png`ï¼‰
2. æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
3. ç¡®è®¤ WebSocket è¿æ¥æ­£å¸¸
4. ç­‰å¾… 2 ç§’åè§‚å¯Ÿæ˜¯å¦æ›´æ–°

### é—®é¢˜3ï¼šè¿›åº¦ç»Ÿè®¡ä¸æ›´æ–°

**å¯èƒ½åŸå› ï¼š**
- æ—¥å¿—æ ¼å¼ä¸åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
- ProgressReporter æœªæ”¶åˆ°æ¶ˆæ¯

**æ’æŸ¥æ­¥éª¤ï¼š**
1. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦åŒ…å« "å¤„ç†ç¬¬ x/y ä¸ª" æ ¼å¼
2. æŸ¥çœ‹ `logging_handler.py` ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼
3. æ‰‹åŠ¨å‘é€è¿›åº¦æµ‹è¯•ï¼š`reporter.send_progress(1, 2)`

### é—®é¢˜4ï¼šåœæ­¢æŒ‰é’®ä¸å“åº”

**å¯èƒ½åŸå› ï¼š**
- `time.sleep` æœªè¢«æ›¿æ¢
- stop_event æœªæ­£ç¡®ä¼ é€’

**æ’æŸ¥æ­¥éª¤ï¼š**
1. ç¡®è®¤è¿è¡Œçš„æ˜¯ `test_with_frontend.py`
2. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ä¸­æ˜¯å¦æœ‰ "âœ“ å¯ä¸­æ–­çš„ sleep å·²é…ç½®"
3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
4. å°è¯•åœ¨ä»£ç ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—

### é—®é¢˜5ï¼šæµè§ˆå™¨æ— æ³•æ‰“å¼€

**å¯èƒ½åŸå› ï¼š**
- ç«¯å£ 8765 è¢«å ç”¨
- é˜²ç«å¢™é˜»æ­¢

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8765

# æ‰‹åŠ¨æ‰“å¼€æµè§ˆå™¨
open http://localhost:8765
```

---

## æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„çŠ¶æ€è¯†åˆ«

ç¼–è¾‘ `frontend/logging_handler.py`ï¼Œåœ¨ `status_patterns` åˆ—è¡¨ä¸­æ·»åŠ ï¼š

```python
self.status_patterns = [
    # ... ç°æœ‰è§„åˆ™ ...
    (r'ä½ çš„æ­£åˆ™è¡¨è¾¾å¼', 'å‰ç«¯æ˜¾ç¤ºçš„çŠ¶æ€æ–‡æœ¬'),
]
```

**ç¤ºä¾‹ï¼š**
```python
# è¯†åˆ«"æ­£åœ¨è¿æ¥æ•°æ®åº“"
(r'æ­£åœ¨è¿æ¥æ•°æ®åº“|connecting to database', 'æ­£åœ¨è¿æ¥æ•°æ®åº“'),
```

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

#### 1. åœ¨ ProgressReporter ä¸­æ·»åŠ æ–¹æ³•

ç¼–è¾‘ `frontend/progress_reporter.py`ï¼š

```python
def send_custom_data(self, data: dict):
    """å‘é€è‡ªå®šä¹‰æ•°æ®"""
    message = {
        "type": "custom",
        "data": data
    }
    self._safe_broadcast(message)
```

#### 2. åœ¨å‰ç«¯å¤„ç†æ¶ˆæ¯

ç¼–è¾‘ `frontend/index.html`ï¼Œåœ¨ WebSocket æ¶ˆæ¯å¤„ç†ä¸­æ·»åŠ ï¼š

```javascript
case 'custom':
    handleCustomData(message.data);
    break;

function handleCustomData(data) {
    console.log('æ”¶åˆ°è‡ªå®šä¹‰æ•°æ®:', data);
    // ä½ çš„å¤„ç†é€»è¾‘
}
```

### ä¿®æ”¹æˆªå›¾æ¨é€é¢‘ç‡

ç¼–è¾‘ `frontend/progress_reporter.py`ï¼š

```python
# é»˜è®¤ 2 ç§’
self.screenshot_min_interval = 2.0

# æ”¹ä¸º 1 ç§’
self.screenshot_min_interval = 1.0
```

### è°ƒæ•´åœæ­¢æŒ‰é’®å“åº”é€Ÿåº¦

ç¼–è¾‘ `tests/test_with_frontend.py`ï¼Œä¿®æ”¹æ£€æŸ¥é—´éš”ï¼š

```python
# é»˜è®¤ 0.1 ç§’
original_time_sleep(min(0.1, remaining))

# æ”¹ä¸º 0.05 ç§’ï¼ˆæ›´å¿«å“åº”ï¼Œä½† CPU å ç”¨å¢åŠ ï¼‰
original_time_sleep(min(0.05, remaining))
```

---

## æ–‡ä»¶ç»“æ„

```
frontend/
â”œâ”€â”€ index.html              # å‰ç«¯ç›‘æ§é¡µé¢ï¼ˆHTML/CSS/JavaScriptï¼‰
â”œâ”€â”€ server.py               # FastAPI + WebSocket æœåŠ¡å™¨
â”œâ”€â”€ progress_reporter.py    # è¿›åº¦ä¸ŠæŠ¥å™¨ï¼ˆç®¡ç† WebSocket è¿æ¥å’Œæ¶ˆæ¯æ¨é€ï¼‰
â”œâ”€â”€ logging_handler.py      # æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆè‡ªå®šä¹‰ logging Handlerï¼‰
â””â”€â”€ README.md               # æœ¬æ–‡æ¡£

tests/
â”œâ”€â”€ test_with_frontend.py          # å¸¦å‰ç«¯ç›‘æ§çš„å®Œæ•´æµ‹è¯•
â”œâ”€â”€ test_frontend_integration.py   # å‰ç«¯é›†æˆæ¨¡æ‹Ÿæµ‹è¯•
â””â”€â”€ test_logging_handler.py        # æ—¥å¿—Handlerå•å…ƒæµ‹è¯•

start_frontend_test.sh      # å¿«é€Ÿå¯åŠ¨è„šæœ¬
```

---

## æ€»ç»“

é€šè¿‡**è‡ªå®šä¹‰ logging Handler** å’Œ **monkey patching** æŠ€æœ¯ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- âœ… æ—¥å¿—å®æ—¶åŒæ­¥ - æ‰€æœ‰ logging è¾“å‡ºè‡ªåŠ¨æ¨é€
- âœ… æ“ä½œçŠ¶æ€è¯†åˆ« - æ™ºèƒ½è¯†åˆ«å½“å‰æ“ä½œ
- âœ… è¿›åº¦ç»Ÿè®¡æ˜¾ç¤º - è‡ªåŠ¨æå–è¿›åº¦ä¿¡æ¯
- âœ… æˆªå›¾å®æ—¶æ¨é€ - æ¯æ¬¡æˆªå›¾è‡ªåŠ¨æ¨é€ï¼ˆ2ç§’é—´éš”ï¼‰
- âœ… æ–‡ç« é“¾æ¥é‡‡é›† - å®æ—¶æ˜¾ç¤ºé‡‡é›†ç»“æœ
- âœ… åœæ­¢æŒ‰é’®å“åº” - æœ€å¤šå»¶è¿Ÿ 0.1 ç§’
- âœ… é›¶ä»£ç ä¾µå…¥ - å®Œå…¨ä¸ä¿®æ”¹ `src/` ä»£ç 

### æ ¸å¿ƒä¼˜åŠ¿

1. **é›¶ä¾µå…¥æ€§** - ä¸ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç 
2. **è‡ªåŠ¨åŒ–** - åªéœ€é…ç½®ä¸€æ¬¡
3. **æ™ºèƒ½è§£æ** - æ­£åˆ™è¡¨è¾¾å¼è‡ªåŠ¨è¯†åˆ«
4. **å®¹é”™æ€§å¼º** - é”™è¯¯ä¸å½±å“ä¸»æµç¨‹
5. **æ˜“äºæ‰©å±•** - ç®€å•ä¿®æ”¹é…ç½®å³å¯

### æŠ€æœ¯æ¶æ„

```
å‰ç«¯é¡µé¢ï¼ˆindex.htmlï¼‰
    â†• WebSocket
æœåŠ¡å™¨ï¼ˆserver.pyï¼‰
    â†• ProgressReporter
æ—¥å¿—æ‹¦æˆªå™¨ï¼ˆlogging_handler.pyï¼‰
    â†• æ‹¦æˆªæ‰€æœ‰ logging
æ ¸å¿ƒå·¥ä½œæµï¼ˆsrc/wechat_ai_daily/ï¼‰
```

æ‰€æœ‰åŠŸèƒ½å·²å®Œå…¨æ‰“é€šï¼Œå¼€ç®±å³ç”¨ï¼ğŸ‰

---

## è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- é¡¹ç›®ä¸»æ–‡æ¡£ï¼š`CLAUDE.md`
- å·¥ä½œæµä»£ç ï¼š`src/wechat_ai_daily/workflows/wechat_autogui.py`
- æµ‹è¯•ä»£ç ï¼š`tests/test_with_frontend.py`
