<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–æµ‹è¯•ç›‘æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å…¨å±€ç§‘æŠ€é£æ ¼ */
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        /* ç»ç’ƒæ€å¡ç‰‡æ•ˆæœ */
        .glass-card {
            background: rgba(17, 25, 40, 0.75);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        /* å‘å…‰è¾¹æ¡†åŠ¨ç”» */
        .glow-border {
            position: relative;
            overflow: hidden;
        }
        
        .glow-border::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #667eea 100%);
            border-radius: inherit;
            z-index: -1;
            animation: glow-rotate 4s linear infinite;
            opacity: 0.5;
        }
        
        @keyframes glow-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* æµå…‰æ•ˆæœ */
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.1) 50%,
                transparent 70%
            );
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        /* è„‰å†²åŠ¨ç”» */
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 20px currentColor; }
            50% { opacity: 0.6; box-shadow: 0 0 5px currentColor; }
        }
        
        /* æ—¥å¿—æ¡ç›®åŠ¨ç”» */
        .log-entry {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* æˆªå›¾å®¹å™¨ */
        .screenshot-container {
            max-height: 500px;
            overflow: hidden;
            border-radius: 12px;
            position: relative;
        }
        
        .screenshot-img {
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 12px;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #764ba2 0%, #667eea 100%);
        }
        
        /* æ¸å˜æ–‡å­— */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* ä½œè€…å¾½ç«  */
        .author-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            animation: badge-glow 2s ease-in-out infinite;
        }
        
        @keyframes badge-glow {
            0%, 100% { box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(102, 126, 234, 0.7); }
        }
        
        /* å½“å‰æ“ä½œå¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .current-op-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }
        
        .current-op-card:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.3);
        }
        
        /* æŒ‰é’®å‘å…‰æ•ˆæœ */
        .btn-glow {
            transition: all 0.3s ease;
        }
        
        .btn-glow:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        /* æˆªå›¾è­¦å‘Š */
        .screenshot-warning {
            animation: fadeInOut 2s ease-in-out infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
        <!-- å¤´éƒ¨ -->
        <div class="glass-card rounded-2xl p-6 mb-6 shimmer">
            <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-4xl">ğŸ¤–</span>
                        <h1 class="text-2xl md:text-3xl font-bold gradient-text">
                            å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–æµ‹è¯•ç›‘æ§
                        </h1>
                    </div>
                    <p class="text-gray-400 text-sm md:text-base ml-12">
                        å®æ—¶ç›‘æ§ RPA æ“ä½œæµç¨‹ Â· AIé©±åŠ¨çš„æ™ºèƒ½é‡‡é›†ç³»ç»Ÿ
                    </p>
                </div>
                
                <!-- ä½œè€…ä¿¡æ¯ -->
                <div class="author-badge flex items-center gap-2">
                    <span>ğŸ‘¨â€ğŸ’»</span>
                    <span>Developed by Doubleç«¥å‘å‘</span>
                </div>
            </div>
            
            <!-- çŠ¶æ€å’Œæ§åˆ¶æŒ‰é’® -->
            <div class="mt-6 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 pt-4 border-t border-gray-700">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3">
                        <span class="text-gray-400 text-sm">çŠ¶æ€:</span>
                        <div class="flex items-center gap-2">
                            <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400"></span>
                            <span id="status-text" class="font-semibold text-lg">ç­‰å¾…è¿æ¥</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-400">
                        è¿›åº¦: <span id="progress-text" class="text-purple-400 font-semibold">0/0</span>
                    </div>
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’® -->
                <div class="flex gap-3">
                    <button id="start-btn" onclick="startWorkflow()" 
                            class="btn-glow px-6 py-2.5 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2"
                            disabled>
                        <span>â–¶ï¸</span>
                        <span>å¼€å§‹æµ‹è¯•</span>
                    </button>
                    <button id="stop-btn" onclick="stopWorkflow()" 
                            class="btn-glow px-6 py-2.5 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-semibold rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none flex items-center gap-2"
                            disabled>
                        <span>â¹ï¸</span>
                        <span>åœæ­¢æµ‹è¯•</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- é‡è¦æç¤º -->
        <div class="glass-card rounded-xl border-l-4 border-yellow-500 p-4 mb-6">
            <div class="flex items-start gap-3">
                <span class="text-2xl">âš ï¸</span>
                <div class="flex-1">
                    <h3 class="font-bold text-yellow-400 mb-2">é‡è¦æç¤ºï¼ˆé¿å…å¹²æ‰° RPAï¼‰</h3>
                    <ul class="text-gray-300 text-sm space-y-1.5">
                        <li class="flex items-start gap-2">
                            <span class="text-yellow-400 mt-0.5">â€¢</span>
                            <span><strong class="text-yellow-300">å»ºè®®å°†æ­¤çª—å£ç½®äºå‰¯å±æŸ¥çœ‹</strong>ï¼Œä¸»å±å¹•ä¿æŒå¾®ä¿¡çª—å£</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-yellow-400 mt-0.5">â€¢</span>
                            <span>è¯·å‹¿ç‚¹å‡»æˆ–åˆ‡æ¢æ­¤æµè§ˆå™¨çª—å£ç„¦ç‚¹ï¼ˆé¿å…å½±å“å¾®ä¿¡æ“ä½œï¼‰</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-yellow-400 mt-0.5">â€¢</span>
                            <span>è‡ªåŠ¨åŒ–è¿è¡ŒæœŸé—´è¯·å‹¿æ“ä½œé¼ æ ‡/é”®ç›˜</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-yellow-400 mt-0.5">â€¢</span>
                            <span>å¦‚éœ€æŸ¥çœ‹è¯¦æƒ…ï¼Œè¯·æœ€å°åŒ–åå¶å°”æŸ¥çœ‹</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦ä¾§ï¼šå½“å‰æ“ä½œå’Œæˆªå›¾ -->
            <div class="space-y-6">
                <!-- å½“å‰æ“ä½œ -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">ğŸ¯</span>
                        <span class="gradient-text">å½“å‰æ“ä½œ</span>
                    </h2>
                    <div class="current-op-card rounded-xl p-6 min-h-[120px] relative overflow-hidden">
                        <div class="relative z-10">
                            <div class="flex items-start gap-3 mb-3">
                                <div class="w-1 h-16 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full"></div>
                                <div class="flex-1">
                                    <div id="current-step" class="text-xl font-bold text-blue-300 mb-2 leading-tight">
                                        ç­‰å¾…å¼€å§‹...
                                    </div>
                                    <div id="current-detail" class="text-gray-400 text-sm leading-relaxed">
                                        å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ç”¨æˆ·è§¦å‘æµ‹è¯•
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å®æ—¶æˆªå›¾ -->
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-3xl">ğŸ“¸</span>
                            <span class="gradient-text">å®æ—¶æˆªå›¾</span>
                        </h2>
                        <div id="screenshot-status" class="text-xs px-3 py-1 rounded-full bg-gray-700 text-gray-400">
                            å¾…æ›´æ–°
                        </div>
                    </div>
                    <div class="screenshot-container glass-card">
                        <div id="screenshot-placeholder" class="flex flex-col items-center justify-center h-64 text-gray-500">
                            <svg class="w-16 h-16 mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p class="screenshot-warning">ç­‰å¾…æˆªå›¾æ•°æ®...</p>
                        </div>
                        <img id="screenshot-img" class="screenshot-img hidden" alt="å®æ—¶æˆªå›¾">
                    </div>
                    <div id="screenshot-time" class="text-xs text-gray-500 mt-3 text-center">
                        æœªæ”¶åˆ°æˆªå›¾
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»Ÿè®¡ã€æ—¥å¿—å’Œç»“æœ -->
            <div class="space-y-6">
                <!-- è¿›åº¦ç»Ÿè®¡ -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">ğŸ“Š</span>
                        <span class="gradient-text">è¿›åº¦ç»Ÿè®¡</span>
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-400">å…¬ä¼—å·é‡‡é›†è¿›åº¦</span>
                                <span id="progress-percent" class="text-purple-400 font-bold">0%</span>
                            </div>
                            <div class="w-full bg-gray-800 rounded-full h-3 overflow-hidden">
                                <div id="progress-bar" class="bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500 shadow-lg" style="width: 0%; box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="glass-card rounded-lg p-4 text-center border border-blue-500/20">
                                <div class="text-3xl font-bold text-blue-400 mb-1" id="stat-accounts">0</div>
                                <div class="text-xs text-gray-400">å…¬ä¼—å·æ•°</div>
                            </div>
                            <div class="glass-card rounded-lg p-4 text-center border border-green-500/20">
                                <div class="text-3xl font-bold text-green-400 mb-1" id="stat-articles">0</div>
                                <div class="text-xs text-gray-400">å·²é‡‡é›†æ–‡ç« </div>
                            </div>
                            <div class="glass-card rounded-lg p-4 text-center border border-purple-500/20">
                                <div class="text-3xl font-bold text-purple-400 mb-1" id="stat-duration">0s</div>
                                <div class="text-xs text-gray-400">è¿è¡Œæ—¶é•¿</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥å¿—è¾“å‡º -->
                <div class="glass-card rounded-xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-3xl">ğŸ“</span>
                            <span class="gradient-text">æ—¥å¿—è¾“å‡º</span>
                        </h2>
                        <label class="flex items-center gap-2 text-xs cursor-pointer">
                            <input type="checkbox" id="auto-scroll-checkbox" checked class="rounded">
                            <span class="text-gray-400">è‡ªåŠ¨æ»šåŠ¨</span>
                        </label>
                    </div>
                    <div id="log-container" class="bg-gray-950 bg-opacity-50 rounded-lg p-3 h-80 overflow-y-auto font-mono text-xs space-y-1">
                        <div class="text-gray-600 flex items-center gap-2">
                            <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                            </svg>
                            <span>ç­‰å¾…æ—¥å¿—æ•°æ®...</span>
                        </div>
                    </div>
                </div>

                <!-- é‡‡é›†ç»“æœ -->
                <div class="glass-card rounded-xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-3xl">ğŸ“‹</span>
                        <span class="gradient-text">é‡‡é›†ç»“æœ</span>
                        <span id="article-count" class="text-sm font-normal text-gray-500 ml-2">(0ç¯‡)</span>
                    </h2>
                    <div id="articles-container" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-gray-600 text-sm flex items-center justify-center py-8">
                            <span>æš‚æ— é‡‡é›†ç»“æœ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="mt-8 text-center text-gray-500 text-xs space-y-2 pb-4">
            <p class="flex items-center justify-center gap-4 flex-wrap">
                <span>è¿æ¥çŠ¶æ€: <span id="ws-status" class="font-semibold">æœªè¿æ¥</span></span>
                <span class="hidden md:inline">|</span>
                <span>æœ€åæ›´æ–°: <span id="last-update">-</span></span>
            </p>
            <p class="text-gray-600">
                Â© 2026 Doubleç«¥å‘å‘ Â· å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–é‡‡é›†ç³»ç»Ÿ v1.0
            </p>
        </div>
    </div>

    <script>
        let ws = null;
        let startTime = null;
        let durationInterval = null;
        let totalAccounts = 0;
        let currentAccount = 0;
        let totalArticles = 0;
        let isRunning = false;
        let lastScreenshotTime = null;
        let screenshotCheckInterval = null;

        // å‘é€æ§åˆ¶å‘½ä»¤åˆ°åç«¯
        function sendCommand(action, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    action: action,
                    data: data
                };
                ws.send(JSON.stringify(message));
                console.log('å‘é€å‘½ä»¤:', action);
            }
        }

        // å¼€å§‹æµ‹è¯•
        function startWorkflow() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å¯åŠ¨æµ‹è¯•');
                return;
            }
            
            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm('ç¡®è®¤å¼€å§‹æµ‹è¯•ï¼Ÿ\n\nè¯·ç¡®ä¿ï¼š\n1. å¾®ä¿¡å®¢æˆ·ç«¯å·²ç™»å½•\n2. æµè§ˆå™¨çª—å£å·²ç§»åˆ°å‰¯å±\n3. å‡†å¤‡å¥½ä¸æ“ä½œé¼ æ ‡/é”®ç›˜\n\nç‚¹å‡»ç¡®å®šå¼€å§‹æµ‹è¯•')) {
                return;
            }
            
            sendCommand('start');
            updateStartButton(false);
            addLog('info', 'ç”¨æˆ·è§¦å‘æµ‹è¯•å¯åŠ¨');
        }

        // åœæ­¢æµ‹è¯•
        function stopWorkflow() {
            if (confirm('ç¡®è®¤åœæ­¢æµ‹è¯•ï¼Ÿ\n\næµ‹è¯•å°†è¢«ä¸­æ–­')) {
                sendCommand('stop');
                addLog('warning', 'ç”¨æˆ·è¯·æ±‚åœæ­¢æµ‹è¯•');
            }
        }

        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartButton(enabled) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            if (enabled) {
                startBtn.disabled = false;
                stopBtn.disabled = true;
            } else {
                startBtn.disabled = true;
                stopBtn.disabled = false;
            }
        }

        // WebSocket è¿æ¥
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8765/ws');
            
            ws.onopen = () => {
                console.log('WebSocket è¿æ¥æˆåŠŸ');
                updateConnectionStatus(true);
                addLog('info', 'å‰ç«¯ç›‘æ§å·²è¿æ¥ï¼Œç­‰å¾…ç”¨æˆ·å¯åŠ¨æµ‹è¯•');
                // è¿æ¥æˆåŠŸåå¯ç”¨å¼€å§‹æŒ‰é’®
                updateStartButton(true);
                
                // å¯åŠ¨æˆªå›¾è¶…æ—¶æ£€æŸ¥
                startScreenshotCheck();
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
                updateLastUpdateTime();
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
                updateConnectionStatus(false);
                addLog('error', 'WebSocket è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨');
            };
            
            ws.onclose = () => {
                console.log('WebSocket è¿æ¥å…³é—­');
                updateConnectionStatus(false);
                updateStartButton(false);
                stopScreenshotCheck();
                // 3ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 3000);
            };
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(data) {
            switch(data.type) {
                case 'status':
                    updateCurrentStatus(data.data);
                    break;
                case 'screenshot':
                    updateScreenshot(data.data);
                    break;
                case 'log':
                    addLog(data.data.level, data.data.message);
                    break;
                case 'progress':
                    updateProgress(data.data);
                    break;
                case 'article':
                    addArticle(data.data);
                    break;
                case 'stats':
                    updateStats(data.data);
                    break;
                case 'workflow_start':
                    handleWorkflowStart(data.data);
                    break;
                case 'workflow_end':
                    handleWorkflowEnd(data.data);
                    break;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            const wsStatus = document.getElementById('ws-status');
            
            if (connected) {
                statusText.textContent = isRunning ? 'è¿è¡Œä¸­' : 'å°±ç»ª âœ“';
                statusDot.className = isRunning ? 
                    'w-3 h-3 rounded-full bg-green-400 pulse-dot' : 
                    'w-3 h-3 rounded-full bg-blue-400';
                wsStatus.textContent = 'å·²è¿æ¥';
                wsStatus.className = 'font-semibold text-green-400';
            } else {
                statusText.textContent = 'æœªè¿æ¥';
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400';
                wsStatus.textContent = 'æœªè¿æ¥';
                wsStatus.className = 'font-semibold text-red-400';
            }
        }

        // æ›´æ–°å½“å‰æ“ä½œçŠ¶æ€
        function updateCurrentStatus(data) {
            document.getElementById('current-step').textContent = data.step || 'è¿›è¡Œä¸­...';
            const detailElement = document.getElementById('current-detail');
            const detail = data.detail || 'æ­£åœ¨æ‰§è¡Œæ“ä½œ...';
            detailElement.textContent = detail;
        }

        // æ›´æ–°æˆªå›¾
        function updateScreenshot(data) {
            const img = document.getElementById('screenshot-img');
            const placeholder = document.getElementById('screenshot-placeholder');
            const timeText = document.getElementById('screenshot-time');
            const statusBadge = document.getElementById('screenshot-status');
            
            img.src = 'data:image/png;base64,' + data.image;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            const now = new Date();
            timeText.textContent = `æ›´æ–°æ—¶é—´: ${now.toLocaleTimeString('zh-CN')}`;
            statusBadge.textContent = 'å·²æ›´æ–°';
            statusBadge.className = 'text-xs px-3 py-1 rounded-full bg-green-500/20 text-green-400';
            
            // è®°å½•æœ€åæˆªå›¾æ—¶é—´
            lastScreenshotTime = Date.now();
        }

        // å¯åŠ¨æˆªå›¾è¶…æ—¶æ£€æŸ¥
        function startScreenshotCheck() {
            stopScreenshotCheck(); // å…ˆæ¸…é™¤æ—§çš„
            screenshotCheckInterval = setInterval(() => {
                if (isRunning && lastScreenshotTime) {
                    const elapsed = Date.now() - lastScreenshotTime;
                    const statusBadge = document.getElementById('screenshot-status');
                    
                    if (elapsed > 30000) { // 30ç§’æ²¡æ”¶åˆ°æˆªå›¾
                        statusBadge.textContent = 'é•¿æ—¶é—´æœªæ›´æ–°';
                        statusBadge.className = 'text-xs px-3 py-1 rounded-full bg-yellow-500/20 text-yellow-400';
                    }
                }
            }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // åœæ­¢æˆªå›¾è¶…æ—¶æ£€æŸ¥
        function stopScreenshotCheck() {
            if (screenshotCheckInterval) {
                clearInterval(screenshotCheckInterval);
                screenshotCheckInterval = null;
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(level, message) {
            const container = document.getElementById('log-container');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œæ¸…ç©ºå ä½ç¬¦
            const placeholder = container.querySelector('.text-gray-600');
            if (placeholder) {
                container.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry flex gap-2 items-start py-1 px-2 rounded hover:bg-gray-800/50 transition-colors';
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            let levelColor = 'text-blue-400';
            let levelText = 'INFO';
            let levelIcon = 'â„¹ï¸';
            
            if (level === 'warning' || level === 'warn') {
                levelColor = 'text-yellow-400';
                levelText = 'WARN';
                levelIcon = 'âš ï¸';
            } else if (level === 'error') {
                levelColor = 'text-red-400';
                levelText = 'ERROR';
                levelIcon = 'âŒ';
            } else if (level === 'success') {
                levelColor = 'text-green-400';
                levelText = 'OK';
                levelIcon = 'âœ…';
            }
            
            logEntry.innerHTML = `
                <span class="text-gray-600 whitespace-nowrap text-xs">${timestamp}</span>
                <span class="${levelColor} whitespace-nowrap font-bold">[${levelText}]</span>
                <span class="text-gray-300 break-words flex-1">${message}</span>
            `;
            
            container.appendChild(logEntry);
            
            // è‡ªåŠ¨æ»šåŠ¨ï¼ˆå¦‚æœå¼€å¯ï¼‰
            const autoScroll = document.getElementById('auto-scroll-checkbox').checked;
            if (autoScroll) {
                container.scrollTop = container.scrollHeight;
            }
            
            // æœ€å¤šä¿ç•™ 300 æ¡æ—¥å¿—
            while (container.children.length > 300) {
                container.removeChild(container.firstChild);
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(data) {
            currentAccount = data.current || 0;
            totalAccounts = data.total || 0;
            
            const percent = totalAccounts > 0 ? Math.round((currentAccount / totalAccounts) * 100) : 0;
            
            document.getElementById('progress-text').textContent = `${currentAccount}/${totalAccounts}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('stat-accounts').textContent = totalAccounts;
        }

        // æ·»åŠ é‡‡é›†åˆ°çš„æ–‡ç« 
        function addArticle(data) {
            const container = document.getElementById('articles-container');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæ¸…ç©ºå ä½ç¬¦
            const placeholder = container.querySelector('.text-gray-600');
            if (placeholder) {
                container.innerHTML = '';
            }
            
            totalArticles++;
            
            const article = document.createElement('div');
            article.className = 'glass-card rounded-lg p-3 log-entry border border-green-500/20 hover:border-green-500/40 transition-all';
            article.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-green-400 font-bold text-sm">${totalArticles}.</span>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm text-gray-300 break-all line-clamp-2">${data.title || data.link}</div>
                        <div class="text-xs text-gray-500 mt-1">${data.date || ''}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(article);
            container.scrollTop = container.scrollHeight;
            
            document.getElementById('article-count').textContent = `(${totalArticles}ç¯‡)`;
            document.getElementById('stat-articles').textContent = totalArticles;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(data) {
            if (data.articles !== undefined) {
                totalArticles = data.articles;
                document.getElementById('stat-articles').textContent = totalArticles;
                document.getElementById('article-count').textContent = `(${totalArticles}ç¯‡)`;
            }
        }

        // å·¥ä½œæµå¼€å§‹
        function handleWorkflowStart(data) {
            isRunning = true;
            updateConnectionStatus(true);
            updateStartButton(false);
            
            startTime = Date.now();
            lastScreenshotTime = Date.now(); // é‡ç½®æˆªå›¾æ—¶é—´
            totalAccounts = data.total_accounts || 0;
            currentAccount = 0;
            totalArticles = 0;
            
            document.getElementById('stat-accounts').textContent = totalAccounts;
            
            // å¯åŠ¨è®¡æ—¶å™¨
            if (durationInterval) clearInterval(durationInterval);
            durationInterval = setInterval(updateDuration, 1000);
            
            addLog('info', `å·¥ä½œæµå¯åŠ¨ï¼Œå…± ${totalAccounts} ä¸ªå…¬ä¼—å·å¾…é‡‡é›†`);
        }

        // å·¥ä½œæµç»“æŸ
        function handleWorkflowEnd(data) {
            isRunning = false;
            updateStartButton(true);
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            
            if (data.success) {
                statusText.textContent = 'å®Œæˆ âœ…';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-400';
                addLog('success', `å·¥ä½œæµå®Œæˆï¼å…±é‡‡é›† ${totalArticles} ç¯‡æ–‡ç« `);
            } else {
                statusText.textContent = data.error === 'ç”¨æˆ·ä¸­æ–­' ? 'å·²åœæ­¢ â¹ï¸' : 'å¤±è´¥ âŒ';
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400';
                addLog('error', `å·¥ä½œæµ${data.error === 'ç”¨æˆ·ä¸­æ–­' ? 'å·²åœæ­¢' : 'å¤±è´¥'}: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é•¿
        function updateDuration() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const durationText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            document.getElementById('stat-duration').textContent = durationText;
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('zh-CN');
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥ WebSocket
        window.addEventListener('load', () => {
            connectWebSocket();
        });

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (durationInterval) clearInterval(durationInterval);
            if (ws) ws.close();
            stopScreenshotCheck();
        });
    </script>
</body>
</html>
