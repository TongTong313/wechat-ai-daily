<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–æµ‹è¯•ç›‘æ§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { 
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .screenshot-container {
            max-height: 500px;
            overflow: hidden;
            border-radius: 8px;
        }
        .screenshot-img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }
        .pulse-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto p-6 max-w-7xl">
        <!-- å¤´éƒ¨ -->
        <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-3">
                        ğŸ¤– å¾®ä¿¡å…¬ä¼—å·è‡ªåŠ¨åŒ–æµ‹è¯•ç›‘æ§
                    </h1>
                    <p class="text-blue-100 mt-2">å®æ—¶ç›‘æ§ RPA æ“ä½œæµç¨‹</p>
                </div>
                <div class="text-right">
                    <div class="flex items-center gap-2 text-lg mb-2">
                        <span id="status-text" class="font-semibold">ç­‰å¾…è¿æ¥</span>
                        <span id="status-dot" class="w-3 h-3 rounded-full bg-yellow-400"></span>
                    </div>
                    <div class="text-blue-100 text-sm mb-3">
                        è¿›åº¦: <span id="progress-text">0/0</span>
                    </div>
                    <!-- æ§åˆ¶æŒ‰é’® -->
                    <div class="flex gap-2">
                        <button id="start-btn" onclick="startWorkflow()" 
                                class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg shadow transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            â–¶ï¸ å¼€å§‹æµ‹è¯•
                        </button>
                        <button id="stop-btn" onclick="stopWorkflow()" 
                                class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled>
                            â¹ï¸ åœæ­¢æµ‹è¯•
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- é‡è¦æç¤º -->
        <div class="bg-yellow-900 border-l-4 border-yellow-500 p-4 mb-6 rounded">
            <div class="flex items-start gap-3">
                <span class="text-2xl">âš ï¸</span>
                <div class="flex-1">
                    <h3 class="font-bold text-yellow-200 mb-2">é‡è¦æç¤ºï¼ˆé¿å…å¹²æ‰° RPAï¼‰</h3>
                    <ul class="text-yellow-100 text-sm space-y-1">
                        <li>â€¢ <strong>å»ºè®®å°†æ­¤çª—å£ç½®äºå‰¯å±æŸ¥çœ‹</strong>ï¼Œä¸»å±å¹•ä¿æŒå¾®ä¿¡çª—å£</li>
                        <li>â€¢ è¯·å‹¿ç‚¹å‡»æˆ–åˆ‡æ¢æ­¤æµè§ˆå™¨çª—å£ç„¦ç‚¹ï¼ˆé¿å…å½±å“å¾®ä¿¡æ“ä½œï¼‰</li>
                        <li>â€¢ è‡ªåŠ¨åŒ–è¿è¡ŒæœŸé—´è¯·å‹¿æ“ä½œé¼ æ ‡/é”®ç›˜</li>
                        <li>â€¢ å¦‚éœ€æŸ¥çœ‹è¯¦æƒ…ï¼Œè¯·æœ€å°åŒ–åå¶å°”æŸ¥çœ‹</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦ä¾§ï¼šå½“å‰æ“ä½œå’Œæˆªå›¾ -->
            <div class="space-y-6">
                <!-- å½“å‰æ“ä½œ -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ¯</span>
                        å½“å‰æ“ä½œ
                    </h2>
                    <div class="bg-gray-700 rounded-lg p-4 min-h-[100px]">
                        <div id="current-step" class="text-lg font-semibold text-blue-300 mb-2">
                            ç­‰å¾…å¼€å§‹...
                        </div>
                        <div id="current-detail" class="text-gray-300 text-sm">
                            
                        </div>
                    </div>
                </div>

                <!-- å®æ—¶æˆªå›¾ -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“¸</span>
                        å®æ—¶æˆªå›¾
                    </h2>
                    <div class="screenshot-container bg-gray-700 rounded-lg">
                        <div id="screenshot-placeholder" class="flex items-center justify-center h-64 text-gray-500">
                            ç­‰å¾…æˆªå›¾æ•°æ®...
                        </div>
                        <img id="screenshot-img" class="screenshot-img hidden" alt="å®æ—¶æˆªå›¾">
                    </div>
                    <div id="screenshot-time" class="text-xs text-gray-400 mt-2 text-center">
                        
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šæ—¥å¿—å’Œé‡‡é›†ç»“æœ -->
            <div class="space-y-6">
                <!-- è¿›åº¦æ¡ -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“Š</span>
                        è¿›åº¦ç»Ÿè®¡
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span>å…¬ä¼—å·é‡‡é›†è¿›åº¦</span>
                                <span id="progress-percent">0%</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-4">
                                <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div class="bg-gray-700 rounded p-3">
                                <div class="text-2xl font-bold text-blue-400" id="stat-accounts">0</div>
                                <div class="text-xs text-gray-400">å…¬ä¼—å·æ•°</div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="text-2xl font-bold text-green-400" id="stat-articles">0</div>
                                <div class="text-xs text-gray-400">å·²é‡‡é›†æ–‡ç« </div>
                            </div>
                            <div class="bg-gray-700 rounded p-3">
                                <div class="text-2xl font-bold text-purple-400" id="stat-duration">0s</div>
                                <div class="text-xs text-gray-400">è¿è¡Œæ—¶é•¿</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ—¥å¿—è¾“å‡º -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“</span>
                        æ—¥å¿—è¾“å‡º
                    </h2>
                    <div id="log-container" class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-xs space-y-1">
                        <div class="text-gray-500">ç­‰å¾…æ—¥å¿—æ•°æ®...</div>
                    </div>
                </div>

                <!-- é‡‡é›†ç»“æœ -->
                <div class="bg-gray-800 rounded-lg shadow-lg p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ğŸ“‹</span>
                        é‡‡é›†ç»“æœ
                        <span id="article-count" class="text-sm font-normal text-gray-400">(0ç¯‡)</span>
                    </h2>
                    <div id="articles-container" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-gray-500 text-sm">æš‚æ— é‡‡é›†ç»“æœ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="mt-6 text-center text-gray-500 text-sm">
            <p>è¿æ¥çŠ¶æ€: <span id="ws-status" class="font-semibold">æœªè¿æ¥</span> | æœ€åæ›´æ–°: <span id="last-update">-</span></p>
        </div>
    </div>

    <script>
        let ws = null;
        let startTime = null;
        let durationInterval = null;
        let totalAccounts = 0;
        let currentAccount = 0;
        let totalArticles = 0;
        let isRunning = false;

        // å‘é€æ§åˆ¶å‘½ä»¤åˆ°åç«¯
        function sendCommand(action, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    action: action,
                    data: data
                };
                ws.send(JSON.stringify(message));
                console.log('å‘é€å‘½ä»¤:', action);
            }
        }

        // å¼€å§‹æµ‹è¯•
        function startWorkflow() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert('WebSocket æœªè¿æ¥ï¼Œæ— æ³•å¯åŠ¨æµ‹è¯•');
                return;
            }
            
            // ç¡®è®¤å¯¹è¯æ¡†
            if (!confirm('ç¡®è®¤å¼€å§‹æµ‹è¯•ï¼Ÿ\n\nè¯·ç¡®ä¿ï¼š\n1. å¾®ä¿¡å®¢æˆ·ç«¯å·²ç™»å½•\n2. æµè§ˆå™¨çª—å£å·²ç§»åˆ°å‰¯å±\n3. å‡†å¤‡å¥½ä¸æ“ä½œé¼ æ ‡/é”®ç›˜\n\nç‚¹å‡»ç¡®å®šå¼€å§‹æµ‹è¯•')) {
                return;
            }
            
            sendCommand('start');
            updateStartButton(false);
            addLog('info', 'ç”¨æˆ·è§¦å‘æµ‹è¯•å¯åŠ¨');
        }

        // åœæ­¢æµ‹è¯•
        function stopWorkflow() {
            if (confirm('ç¡®è®¤åœæ­¢æµ‹è¯•ï¼Ÿ\n\næµ‹è¯•å°†è¢«ä¸­æ–­')) {
                sendCommand('stop');
                addLog('warning', 'ç”¨æˆ·è¯·æ±‚åœæ­¢æµ‹è¯•');
            }
        }

        // æ›´æ–°å¼€å§‹æŒ‰é’®çŠ¶æ€
        function updateStartButton(enabled) {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            if (enabled) {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                stopBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // WebSocket è¿æ¥
        function connectWebSocket() {
            ws = new WebSocket('ws://localhost:8765/ws');
            
            ws.onopen = () => {
                console.log('WebSocket è¿æ¥æˆåŠŸ');
                updateConnectionStatus(true);
                addLog('info', 'å‰ç«¯ç›‘æ§å·²è¿æ¥ï¼Œç­‰å¾…ç”¨æˆ·å¯åŠ¨æµ‹è¯•');
                // è¿æ¥æˆåŠŸåå¯ç”¨å¼€å§‹æŒ‰é’®
                updateStartButton(true);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
                updateLastUpdateTime();
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket é”™è¯¯:', error);
                updateConnectionStatus(false);
                addLog('error', 'WebSocket è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å¯åŠ¨');
            };
            
            ws.onclose = () => {
                console.log('WebSocket è¿æ¥å…³é—­');
                updateConnectionStatus(false);
                updateStartButton(false);
                // 3ç§’åå°è¯•é‡è¿
                setTimeout(connectWebSocket, 3000);
            };
        }

        // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
        function handleMessage(data) {
            switch(data.type) {
                case 'status':
                    updateCurrentStatus(data.data);
                    break;
                case 'screenshot':
                    updateScreenshot(data.data);
                    break;
                case 'log':
                    addLog(data.data.level, data.data.message);
                    break;
                case 'progress':
                    updateProgress(data.data);
                    break;
                case 'article':
                    addArticle(data.data);
                    break;
                case 'stats':
                    updateStats(data.data);
                    break;
                case 'workflow_start':
                    handleWorkflowStart(data.data);
                    break;
                case 'workflow_end':
                    handleWorkflowEnd(data.data);
                    break;
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            const wsStatus = document.getElementById('ws-status');
            
            if (connected) {
                statusText.textContent = isRunning ? 'è¿è¡Œä¸­' : 'å°±ç»ª';
                statusDot.className = isRunning ? 
                    'w-3 h-3 rounded-full bg-green-400 pulse-dot' : 
                    'w-3 h-3 rounded-full bg-blue-400';
                wsStatus.textContent = 'å·²è¿æ¥';
                wsStatus.className = 'font-semibold text-green-400';
            } else {
                statusText.textContent = 'æœªè¿æ¥';
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400';
                wsStatus.textContent = 'æœªè¿æ¥';
                wsStatus.className = 'font-semibold text-red-400';
            }
        }

        // æ›´æ–°å½“å‰æ“ä½œçŠ¶æ€
        function updateCurrentStatus(data) {
            document.getElementById('current-step').textContent = data.step || 'è¿›è¡Œä¸­...';
            document.getElementById('current-detail').textContent = data.detail || '';
        }

        // æ›´æ–°æˆªå›¾
        function updateScreenshot(data) {
            const img = document.getElementById('screenshot-img');
            const placeholder = document.getElementById('screenshot-placeholder');
            const timeText = document.getElementById('screenshot-time');
            
            img.src = 'data:image/png;base64,' + data.image;
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            const now = new Date();
            timeText.textContent = `æ›´æ–°æ—¶é—´: ${now.toLocaleTimeString('zh-CN')}`;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(level, message) {
            const container = document.getElementById('log-container');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œæ¸…ç©ºå ä½ç¬¦
            if (container.querySelector('.text-gray-500')) {
                container.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry flex gap-2 items-start';
            
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            let levelColor = 'text-gray-400';
            let levelText = 'INFO';
            
            if (level === 'warning' || level === 'warn') {
                levelColor = 'text-yellow-400';
                levelText = 'WARN';
            } else if (level === 'error') {
                levelColor = 'text-red-400';
                levelText = 'ERROR';
            } else if (level === 'success') {
                levelColor = 'text-green-400';
                levelText = 'SUCCESS';
            }
            
            logEntry.innerHTML = `
                <span class="text-gray-500 whitespace-nowrap">[${timestamp}]</span>
                <span class="${levelColor} font-semibold whitespace-nowrap">[${levelText}]</span>
                <span class="text-gray-300 break-words flex-1">${message}</span>
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // æœ€å¤šä¿ç•™200æ¡æ—¥å¿—
            while (container.children.length > 200) {
                container.removeChild(container.firstChild);
            }
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress(data) {
            currentAccount = data.current || 0;
            totalAccounts = data.total || 0;
            
            const percent = totalAccounts > 0 ? Math.round((currentAccount / totalAccounts) * 100) : 0;
            
            document.getElementById('progress-text').textContent = `${currentAccount}/${totalAccounts}`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('stat-accounts').textContent = totalAccounts;
        }

        // æ·»åŠ é‡‡é›†åˆ°çš„æ–‡ç« 
        function addArticle(data) {
            const container = document.getElementById('articles-container');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€ç¯‡æ–‡ç« ï¼Œæ¸…ç©ºå ä½ç¬¦
            if (container.querySelector('.text-gray-500')) {
                container.innerHTML = '';
            }
            
            totalArticles++;
            
            const article = document.createElement('div');
            article.className = 'bg-gray-700 rounded p-3 log-entry';
            article.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-green-400 font-bold">${totalArticles}.</span>
                    <div class="flex-1">
                        <div class="text-sm text-gray-300 break-all">${data.title || data.link}</div>
                        <div class="text-xs text-gray-500 mt-1">${data.date || ''}</div>
                    </div>
                </div>
            `;
            
            container.appendChild(article);
            container.scrollTop = container.scrollHeight;
            
            document.getElementById('article-count').textContent = `(${totalArticles}ç¯‡)`;
            document.getElementById('stat-articles').textContent = totalArticles;
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(data) {
            if (data.articles !== undefined) {
                totalArticles = data.articles;
                document.getElementById('stat-articles').textContent = totalArticles;
                document.getElementById('article-count').textContent = `(${totalArticles}ç¯‡)`;
            }
        }

        // å·¥ä½œæµå¼€å§‹
        function handleWorkflowStart(data) {
            isRunning = true;
            updateConnectionStatus(true);
            updateStartButton(false);
            
            startTime = Date.now();
            totalAccounts = data.total_accounts || 0;
            currentAccount = 0;
            totalArticles = 0;
            
            document.getElementById('stat-accounts').textContent = totalAccounts;
            
            // å¯åŠ¨è®¡æ—¶å™¨
            if (durationInterval) clearInterval(durationInterval);
            durationInterval = setInterval(updateDuration, 1000);
            
            addLog('info', `å·¥ä½œæµå¯åŠ¨ï¼Œå…± ${totalAccounts} ä¸ªå…¬ä¼—å·å¾…é‡‡é›†`);
        }

        // å·¥ä½œæµç»“æŸ
        function handleWorkflowEnd(data) {
            isRunning = false;
            updateStartButton(true);
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }
            
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            
            if (data.success) {
                statusText.textContent = 'å®Œæˆ âœ…';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-400';
                addLog('success', `å·¥ä½œæµå®Œæˆï¼å…±é‡‡é›† ${totalArticles} ç¯‡æ–‡ç« `);
            } else {
                statusText.textContent = data.error === 'ç”¨æˆ·ä¸­æ–­' ? 'å·²åœæ­¢ â¹ï¸' : 'å¤±è´¥ âŒ';
                statusDot.className = 'w-3 h-3 rounded-full bg-red-400';
                addLog('error', `å·¥ä½œæµ${data.error === 'ç”¨æˆ·ä¸­æ–­' ? 'å·²åœæ­¢' : 'å¤±è´¥'}: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
            }
        }

        // æ›´æ–°è¿è¡Œæ—¶é•¿
        function updateDuration() {
            if (!startTime) return;
            
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const durationText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            document.getElementById('stat-duration').textContent = durationText;
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('zh-CN');
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥ WebSocket
        window.addEventListener('load', () => {
            connectWebSocket();
        });

        // é¡µé¢å…³é—­æ—¶æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (durationInterval) clearInterval(durationInterval);
            if (ws) ws.close();
        });
    </script>
</body>
</html>
